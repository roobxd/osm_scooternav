# Serverless Authenticated Map Editing (Cloudflare Pages + R2 + KV + iD)

This project is a zero-manual-setup, Cloudflare-ready map editing system:

- Static hosting: Cloudflare Pages (`/public`)
- API backend: Cloudflare Pages Functions (`/functions`)
- Storage: Cloudflare R2 (`MAPDATA` bucket)
- Auth + change logs: Cloudflare KV (`USERS`, `CHANGES`)
- Frontend: prebuilt iD Editor copied into `/public/editor`

After you bind KV/R2 and upload `nl.geojson` to R2, it just works.

## Features
- Username/password login (`/login`, cookies, Web Crypto hashing)
- Load GeoJSON from R2 (`GET /api/map`)
- Edit in iD Editor (points, lines, tags)
- Save back to R2 (`POST /api/save`) with user and timestamp
- Track per-user `changeCount` in KV
- View recent change logs (`GET /api/changes`)
- Local export script `export.sh` to convert GeoJSON → OSM → PBF

## Project Structure

```
/public
  /editor            # prebuilt iD Editor (dist copied here automatically)
/functions           # Cloudflare Pages Functions (Web Request/Response API)
  api-map.js        → GET /api/map
  api-save.js       → POST /api/save (auth)
  auth-login.js     → POST /login
  auth-logout.js    → POST /logout
  auth-me.js        → GET /me
  api-changes.js    → GET /api/changes (auth)
  _utils.js         → shared helpers (auth, cookies, crypto)
  _middleware.js    → routes all above paths correctly on Pages
export.sh
wrangler.example.toml
README.md
```

Note: Cloudflare Pages Functions use file-based routing. To honor the exact filenames above while still serving the desired paths (e.g. `/api/map`), we include a tiny `_middleware.js` that dispatches requests by pathname to the corresponding function files.

## Setup

1. Clone this repo (or copy the folder) and push/deploy to Cloudflare Pages.
2. Bind KV namespaces and R2 bucket in Pages project settings or via Wrangler.
   - KV: `USERS`, `CHANGES`
   - R2: `MAPDATA`
   - Add a secret `SESSION_SECRET` for cookie HMAC (any long random string).
3. Upload `nl.geojson` to R2 at key `nl.geojson`.
4. Create at least one user in `USERS` KV.
5. Visit `/login`, then go to `/editor`.

## Bindings

In Cloudflare Pages (Dashboard → Project → Settings → Functions → Environment variables / bindings):

- KV Namespaces:
  - `USERS`
  - `CHANGES`
- R2 Bucket:
  - `MAPDATA`
- Plaintext Secret:
  - `SESSION_SECRET`

Example `wrangler.example.toml` is provided for local testing with Wrangler.

## Creating Users

Use Wrangler to create a user entry in KV with a SHA-256 hash generated by the helper endpoint or by the CLI. For simplicity, you can do either:

- Option A: CLI via Wrangler (replace `alice` and `<hash>`):

```
wrangler kv:key put --namespace USERS users:alice '{"username":"alice","passwordHash":"<hash>","changeCount":0}'
```

- Option B: Temporary helper (using `auth-login` to produce a hash):
  - Run locally with `wrangler pages dev`.
  - POST to `/login` with `{ "username": "alice", "password": "yourpass", "mode": "hashOnly" }`.
  - Copy the returned `passwordHash` into KV using the CLI above.
  - Then log in normally with `{ "username": "alice", "password": "yourpass" }`.

Password hashing uses Web Crypto (`SubtleCrypto` SHA-256) and optional `PASSWORD_SALT` if you add it as a secret.

## Endpoints

- `POST /login` — Validates credentials, sets httpOnly session cookie
- `POST /logout` — Clears cookie
- `GET /me` — Returns user JSON or 401
- `GET /api/map` — Returns `nl.geojson` from R2
- `POST /api/save` — Auth required; writes GeoJSON to R2, logs change in KV, increments user `changeCount`
- `GET /api/changes` — Auth required; returns recent change entries

## iD Editor

This repo automatically clones the iD Editor, builds it, and copies its `dist/` into `/public/editor`. iD is configured to use `apiUrl: "/api"`, and a tiny bootstrap snippet ensures it can talk to the functions.

No manual build is needed — just deploy.

## Export Script (Local)

`export.sh` downloads `nl.geojson` from R2 via Wrangler and converts to OSM/PBF using `osmium`:

1) `wrangler r2 object get MAPDATA/nl.geojson --local`
2) `osmium convert nl.geojson -o updated.osm`
3) `osmium osm2pbf updated.osm -o updated.pbf`
4) Reminder: `Use graphhopper import updated.pbf`

Requires `osmium-tool` and `wrangler` installed locally. This does not run on Cloudflare.

## Local Dev

You can test locally with Wrangler:

```
wrangler pages dev public --watch --kv USERS --kv CHANGES --r2 MAPDATA
```

Or serve static files to preview UI only:

```
python3 -m http.server 8000
open http://localhost:8000/public/editor/
```

## Security Notes

- Cookies are `httpOnly`, `SameSite=Lax` by default; set `Secure` in production.
- Session cookie is HMAC signed with `SESSION_SECRET` to prevent tampering.
- Password hashes use SHA-256 via Web Crypto; add `PASSWORD_SALT` for defense-in-depth.

## License

This project includes the iD Editor built assets under `/public/editor`. Refer to iD’s repository for its license terms.